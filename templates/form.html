{% extends "base.html" %}

{% import "common.html" as common %}

{% block classes %}page edit{% endblock %}
{% block body %}

<div class="header">
<a href="/">Bridge Resource Finder</a>
</div>

{% macro checkedif(cond) -%}
{% if cond %}checked{%endif%}
{%- endmacro %}

<div class="content">
<form method=post>
<input type=hidden name=id value="{{ loc.key.id() if loc }}">
<input type=hidden name=service_id value="{{ service.service_id }}">
<input type=hidden name=r value="{{ redirect_to }}">
<input type=hidden name=num_times value="{{ (service.times|length) + 1 if service else 1 }}">
<table>
<tbody>
  <tr><td>Name</td><td><input name=name value="{{ loc.name }}"></td></tr>
  <tr><td>Address</td><td><input name=address></td></tr>
  <tr><td>Geo Location</td><td><input name=location></td></tr>
  <tr><td>Phones</td>
      <td>
        <textarea name=phones>{% for phone in loc.phones -%}
          {{ common.phone(phone) }}&#13;&#10;
        {%- endfor %}</textarea>
      </td>
  </tr>
  <tr><td>Website</td><td><input name=website></td></tr>
  <tr><td>Wheelchair Access</td>
      <td><input type=checkbox name=accessible {{ checkedif(loc.accessible) }}></td></tr>
</tbody>
<tbody>
  <tr><th colspan=2>
    {% for other_service in loc.services %}
      <a class="service-tab {% if other_service.service_id == service.service_id %}self{% endif %}"
         href="/edit?id={{ loc.key.id() }}&service_id={{ other_service.service_id }}&r={{ request.get('r') }}">
        {{ other_service.service_detail }}
      </a>
    {% endfor %}
    {% if service %}
      <a href="/edit?id={{ loc.key.id() }}&r={{ request.get('r') }}">+ Add New Service</a>
    {% else %}
      <span class="service-tab self">New Service</span>
    {% endif %}
    </th>
  </tr>
</tbody>
<tbody>
  <tr><td>Service Type</td><td>
  <select name=service_type>
    <option>
    {% for service_type in ServiceType.names() %}
      <option value="{{ service_type }}"
              {% if service and
                    service.service_type == ServiceType.for_name(service_type) %}
                selected
              {% endif %}>{{ _(service_type) }}
    {% endfor %}
  </select>
  </td></tr>
  <tr><td>Service Detail</td>
      <td><input name=service_detail value="{{ service.service_detail }}"></td></tr>
</tbody>
<tbody>
  <tr><td></td><td>
  {% macro time_option(hour, minute, time=none) -%}
    {% set display = "%02d:%02d"|format(hour, minute) %}
    <option value="{{ display }}"
            {% if time and time.hour == hour and time.minute == minute %}
              selected
            {% endif %}>{{ display }}
  {%- endmacro %}
  
  {% macro time_fields(index, time) -%}
    <tbody>
      <tr><td>Days</td><td>
        {% for day in ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'] %}
        <label><input type=checkbox
                      name=days_{{ day.lower() }}_{{ index }}
                      {% if time and loop.index0 in time.days %}
                        checked
                      {% endif %}>
              {{ day }}</label>
        {% endfor %}
      </td></tr>
      <tr><td>Times</td><td>
        <select name=start_{{ index }}>
        {% for hour in range(24) %}
          {{ time_option(hour, 0, time.start) }}
          {{ time_option(hour, 30, time.start) }}
        {% endfor %}
        </select>
        -
        <select name=end_{{ index }}>
        {% for hour in range(24) %}
          {{ time_option(hour, 0, time.end) }}
          {{ time_option(hour, 30, time.end) }}
        {% endfor %}
        </select>
      </td></tr>
    </tbody>
  {%- endmacro %}

  <table>
  {% for time in service.times %}
    {{ time_fields(loop.index0, time) }}
  {% endfor %}
  {% if not service.times or request.get('addtime') %}
    {{ time_fields(service.times|length, none) }}
  {% else %}
    <tbody><tr><td colspan=2>
      <a href="/edit?id={{ loc.key.id() }}&service_id={{ service.service_id }}&r={{ request.get('r') }}&addtime=y">
        + Add Other Times
      </a>
    </td></tr></tbody>
  {% endif %}
  </table>

  </td></tr>
</tbody>
<tbody>
  <tr><td>Requires Ticket</td>
      <td><input type=checkbox name=requires_ticket {{ checkedif(service.requires_ticket) }}></td>
  </tr>
  <tr><td>Requires Local Address</td>
      <td><input type=checkbox name=requires_local_addr {{ checkedif(service.requires_local_addr) }}></td>
  </tr>
  <tr><td>Requires Church Attendence</td>
      <td><input type=checkbox name=requires_church_attend {{ checkedif(service.requires_church_attend) }}></td>
  </tr>
  <tr><td>Extra Notes</td>
      <td><textarea rows=10 cols=40 name=service_notes>{{ service.extra_notes }}</textarea>
      </td>
  </tr>
</tbody>
</table>
<input type=submit>
</form>
</div>
{% endblock %}
